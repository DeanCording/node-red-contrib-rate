# node-red-contrib-rate

A Node-RED node for calculating the rate of change of a message property.

Rates of change are calculated based on the message property (`msg.topic`), so multiple topics can be passed through the node to calculate the individual rates of change for each topic.
The timebase can be chosen from *system time* (i.e. actual time of Node-RED) or to a timestamp given in the message containing the evaluated message topic.


![node-appearance](assets/node-appearance.png "Node appearance")  
**Fig. 1:** Node appearance

<a name="installation"></a>
## Installation

<a name="installation_in_node-red"></a>
### In Node-RED (preferred)
* Via Manage Palette -> Search for "node-red-contrib-rate"

<a name="installation_in_a_shell"></a>
### In a shell
* go to the Node-RED installation folder, e.g.: `~/.node-red`
* run `npm install node-red-contrib-rate`

<a name="usage"></a>
## Usage

<a name="node_configuration"></a>
### Node Configuration

![node-settings](assets/node-settings.png "Node properties")  
**Fig. 2:** Node properties (example hysteresis node)

#### Input
The input data to which the rate calulation refers can be selected to be a `msg` property, or a `flow` resp. `global` variable.  
With this option to choose the input property of a `msg` input, several `rate` nodes may be used in parallel (i.e. inputs connected to the identical node output) to get the rate of different properties of the same messages.

#### Rate
This is the output property name into which the node puts its rate calculation result for the chosen *Input* variable. This *Rate* property denotes the data at the nodes output messages.

#### Timestamp
The rate of change of the *Input* property data is related to a time (see also *Rate Period* below). It is calculated from the datapoints given by **[*Input* property; *Timestamp* property]**.

The Timestamp configuration describes instant of time to which the rate of change is related to:
- ***Now*** uses the current system time in milliseconds.  
- A ***property*** from the incoming `msg`, a flow or a global variable could be used for timestamping the input data.  


#### Rate Period
*Rate Period* specifies the number of timestamp units the rate of change is related.  
For example, if the timestamp is in milliseconds, *Rate Period* of 1000 would calculate the rate of change per second.  
See also  [Example 1](#timestamp_example1).

See also Fig. 3: The shorter the *Rate Period* value is, the smaller the output `msg.rate` will be.

<img src="assets/node-settings-rate.png" title="Rate Period input" width="450" />

**Fig. 3:** `Rate Period`



<a name="input"></a>
### Input
The input data will be taken from the incoming `msg`. It is possible to measure the rate of several values (properties) of an incoming `msg`, therefor the node configuration property *Input* is present.

<img src="assets/several-msg-input-values.png" title="Several message input values" width="500" />

**Fig. 4:** Evaluating several values from the same `msg`

**Input data values with own timestamp**  
If you have input messages containing their own timestamp information (e.g. because the data and timestamp were generated by a  value latching instance) the rate of change can be evaluated by using the message timestamp data as the *Timestamp* node configuration property. To achieve this, change the *Timestamp* node configuration property to the input `msg.property` where the timestamp value is located.

**Input data conversion**  
The format of the input data will be converted as possible. You may also use mixed input data types, e.g. numbers or strings with  the same rate node. This could be the case if the rate node is fed from different source nodes with different *Input* formats (like shown in [Example 2](#values_example2)).


<a name="output"></a>
### Output
The output is the rate of change of the *Input* data. It can be routed to any `output.msg` property, this is configured via the node configuration property *Rate*.


<a name="examples"></a>
## Examples
***
**Remark**: Example flows are present in the examples subdirectory. In Node-RED they can be imported via the import function and then selecting *Examples* in the vertical tab menue.
***

<a name="timestamp_example1"></a>
### Example 1: Measuring the system timestamp
This example measures the timestamp of the system. The result should be a constant rate. Depending on the *Rate Period* value you get different rates due to a different measurement time references.  
Change the *Rate Period* of the rate node and examine what happens!

<img src="assets/timestamp-example.png" title="Exampe 1" width="550" />
<p>

**Fig. 5:** Timestamp measuring example

<details>
  <summary>Click to expand code snippet for the <em><b>example flow</b></em>.</summary>

```javascript
[{"id":"704bb737.12369","type":"rate","z":"e4f2d114.92c87","name":"","inputField":"payload","inputFieldType":"msg","outputField":"rate","outputFieldType":"msg","timestampField":"","timestampFieldType":"now","ratePeriod":"1000","x":610,"y":240,"wires":[["6c2fcfe1.3b1808","e7703b87.cb4c"]]},{"id":"dfb476d3.40188","type":"inject","z":"e4f2d114.92c87","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":430,"y":240,"wires":[["704bb737.12369"]]},{"id":"6c2fcfe1.3b1808","type":"debug","z":"e4f2d114.92c87","name":"","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"rate","targetType":"msg","x":810,"y":240,"wires":[]},{"id":"e7703b87.cb4c","type":"debug","z":"e4f2d114.92c87","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","x":790,"y":180,"wires":[]}]
```
</details>
<br>




<a name="values_example2"></a>
### Example 2: Measuring value changes

<img src="assets/value-example.png" title="Exampe 2" width="550" />
<p>

**Fig. 6:** Value measuring example

<details>
  <summary>Click to expand code snippet for the <em><b>example flow</b></em>.</summary>

```javascript
[{"id":"ff0f0e81.89655","type":"rate","z":"e4f2d114.92c87","name":"","inputField":"payload","inputFieldType":"msg","outputField":"rate","outputFieldType":"msg","timestampField":"","timestampFieldType":"now","ratePeriod":"1000","x":1610,"y":240,"wires":[["e37023d.df43c6","c4d30aec.801898"]]},{"id":"e37023d.df43c6","type":"debug","z":"e4f2d114.92c87","name":"","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"rate","targetType":"msg","x":1830,"y":240,"wires":[]},{"id":"c4d30aec.801898","type":"debug","z":"e4f2d114.92c87","name":"","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","x":1810,"y":180,"wires":[]},{"id":"55b4d3d5.77305c","type":"inject","z":"e4f2d114.92c87","name":"","topic":"","payload":"-10","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1370,"y":200,"wires":[["ff0f0e81.89655"]]},{"id":"8266cce.4d6eab","type":"inject","z":"e4f2d114.92c87","name":"","topic":"","payload":"100","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1370,"y":240,"wires":[["ff0f0e81.89655"]]},{"id":"96da2b61.abc24","type":"inject","z":"e4f2d114.92c87","name":"","topic":"","payload":"1000","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1370,"y":280,"wires":[["ff0f0e81.89655"]]}]
```
</details>
